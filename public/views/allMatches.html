<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BloodMatch - All Matches</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root { --red: #b91c1c; --yellow: #f59e0b; --light: #fef2f2; --dark: #0f172a; --gold: #fbbf24; }
    body { font-family: 'Inter', sans-serif; background: var(--light); color: var(--dark); }
    .navbar { background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,.05); padding: .8rem 0; position: sticky; top: 0; z-index: 1000; }
    .navbar-brand { font-weight: 700; color: var(--red); font-size: 1.5rem; }
    .nav-btn { background: none; border: none; color: var(--dark); font-weight: 500; font-size: .9rem; padding: .5rem 1rem; border-radius: 50px; transition: all .3s; }
    .nav-btn:hover { background: #fee2e2; color: var(--red); }
    .nav-btn.active { background: var(--red); color: #fff; font-weight: 600; }
    .btn-logout { border: 1.5px solid var(--red); color: var(--red); border-radius: 50px; padding: .3rem 1rem; font-weight: 700; font-size: .9rem; }
    .btn-logout:hover { background: var(--red); color: #fff; }
    .card { border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,.1); margin-bottom: 2rem; }
    .card-header { background: var(--red); color: #fff; font-weight: 700; }
    .table thead { background: var(--red); color: #fff; }
    .distance-badge { background: var(--yellow); color: #1f2937; font-weight: 600; padding: 0.25rem 0.6rem; border-radius: 50px; font-size: 0.8rem; }
    .premium-badge { background: linear-gradient(135deg, var(--gold), #f59e0b); color: #1f2937; font-weight: 700; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 50px; display: inline-flex; align-items: center; gap: 0.3rem; }
    .buy-premium-highlight { background: linear-gradient(145deg, var(--red), #1e40af); color: #fff; border: none; border-radius: 50px; padding: .5rem 1.2rem; font-weight: 700; font-size: .85rem; }
    .buy-premium-highlight:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 18px rgba(185,28,28,.4); }
    .buy-premium-highlight:disabled { background: linear-gradient(145deg, var(--gold), #f59e0b); color: #1f2937; }
    #paginationControls { display: flex; justify-content: center; gap: 1rem; margin: 2rem 0; }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="/dashboard">ðŸ©¸BloodMatch</a>
      <div class="ms-auto d-flex align-items-center gap-2 flex-wrap">
        <button class="nav-btn" onclick="goTo('/dashboard')">Home</button>
        <button class="nav-btn active">All Matches</button>
        <button class="nav-btn" id="notificationBtn">Notifications</button>
        <button class="nav-btn" onclick="goTo('/profile')">Profile</button>
        <button class="buy-premium-highlight" id="buyPremiumBtn">Buy Premium</button>
        <button class="btn-logout" id="logoutBtn">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <h2 class="mb-4 d-flex align-items-center gap-2">
      All Available Matches Worldwide
      <span id="premiumTag" class="premium-badge" style="display:none;">Premium</span>
    </h2>

    <!-- Filters: Only Blood Group + Per Page -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-5">
            <label class="form-label fw-semibold">Blood Group (Optional)</label>
            <select class="form-select" id="bloodGroupFilter">
              <option value="">All Blood Groups</option>
              <option>A+</option><option>A-</option>
              <option>B+</option><option>B-</option>
              <option>AB+</option><option>AB-</option>
              <option>O+</option><option>O-</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Results Per Page</label>
            <select class="form-select" id="limitFilter">
              <option>2</option>
              <option selected>5</option>
              <option>10</option>
              <option>20</option>
              <option>50</option>
            </select>
          </div>
          <div class="col-md-3">
            <button class="btn btn-danger w-100" id="searchBtn">Search</button>
          </div>
        </div>
        <div class="mt-3 text-muted small">
          Showing <strong>all users worldwide</strong> 
        </div>
      </div>
    </div>

    <!-- Results -->
    <div class="card" id="resultsCard" style="display:none;">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span id="resultTitle">Loading...</span>
        <small id="resultCount" class="text-light opacity-75"></small>
      </div>
      <div class="card-body p-0">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th>Name</th>
              <th>Blood Group</th>
              <th>Location</th>
              <th>Distance</th>
              <th>Phone</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="matchesTableBody"></tbody>
        </table>
      </div>
      <div id="paginationControls">
        <button class="btn btn-outline-danger" id="prevBtn" disabled>Previous</button>
        <span id="pageInfo" class="fw-semibold">Page 1</span>
        <button class="btn btn-outline-danger" id="nextBtn" disabled>Next</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script>
    const token = localStorage.getItem("token");
    let currentPage = 1;
    let totalPages = 1;
    let isPremium = false;

    function goTo(path) { window.location.href = path; }

    document.getElementById("logoutBtn").onclick = () => {
      localStorage.removeItem("token");
      window.location.href = "/login";
    };

    document.getElementById("notificationBtn").onclick = () => {
      if (!isPremium) alert("Upgrade to Premium!");
      else window.location.href = "/reminders/getNotificationPage";
    };

    async function initApp() {
      if (!token) return window.location.href = "/login";

      try {
        const res = await axios.get("http://localhost:3000/profile/data", {
          headers: { Authorization: `Bearer ${token}` }
        });
        isPremium = res.data.isPremiumUser === true;
        document.getElementById("premiumTag").style.display = isPremium ? "inline-flex" : "none";

        const buyBtn = document.getElementById("buyPremiumBtn");
        if (isPremium) {
          buyBtn.innerHTML = "Premium Member";
          buyBtn.disabled = true;
        } else {
          buyBtn.innerHTML = "Buy Premium";
          buyBtn.onclick = () => alert("Payment coming soon!");
        }

        searchMatches(); // Auto-load
      } catch (err) {
        if (err.response?.status === 401) {
          localStorage.removeItem("token");
          window.location.href = "/login";
        }
      }
    }

    async function searchMatches(page = 1) {
      // if (!token || !isPremium) return alert("Premium membership required!");

      currentPage = page;
      const bloodGroup = document.getElementById("bloodGroupFilter").value || "";
      const limit = document.getElementById("limitFilter").value;

      const params = new URLSearchParams({ page, limit });
      if (bloodGroup) params.append("bloodGroup", bloodGroup);

      document.getElementById("resultsCard").style.display = "block";
      document.getElementById("matchesTableBody").innerHTML = `
        <tr><td colspan="6" class="text-center py-5">
          <div class="spinner-border text-danger"></div>
        </td></tr>`;

      try {
        const res = await axios.get(`http://localhost:3000/geocode/match/all/data?${params}`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        const d = res.data.data;
        const matches = d.matches || [];
        totalPages = d.pagination.totalPages || 1;

        document.getElementById("resultTitle").textContent = 
          `Found ${d.pagination.total} ${d.info.showing || "matches"}`;
        document.getElementById("resultCount").textContent = `${matches.length} shown`;

        if (matches.length === 0) {
          document.getElementById("matchesTableBody").innerHTML = `
            <tr><td colspan="6" class="text-center py-5 text-muted">
              No users found with this blood group.
            </td></tr>`;
        } else {
          document.getElementById("matchesTableBody").innerHTML = matches.map(m => `
            <tr>
              <td><strong>${m.name}</strong></td>
              <td><span class="badge bg-danger">${m.bloodGroup}</span></td>
              <td>
                <div class="fw-semibold">${m.city.split(',')[0]}</div>
                <small class="text-muted">${m.city.split(',').slice(1).join(', ')}</small>
              </td>
              <td><span class="distance-badge">${m.distance} km</span></td>
              <td>${m.phonenumber || 'â€”'}</td>
              <td>
                <button class="btn btn-sm btn-outline-danger" onclick="alert('Call: ${m.phonenumber || 'Not available'}')">
                  Contact
                </button>
              </td>
            </tr>
          `).join("");
        }

        document.getElementById("pageInfo").textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById("prevBtn").disabled = currentPage <= 1;
        document.getElementById("nextBtn").disabled = currentPage >= totalPages;

      } catch (err) {
        console.error(err);
        document.getElementById("matchesTableBody").innerHTML = `
          <tr><td colspan="6" class="text-center py-5 text-danger">
            Failed to load matches.
          </td></tr>`;
      }
    }

    document.getElementById("searchBtn").onclick = () => searchMatches(1);
    document.getElementById("prevBtn").onclick = () => { if (currentPage > 1) searchMatches(currentPage - 1); };
    document.getElementById("nextBtn").onclick = () => { if (currentPage < totalPages) searchMatches(currentPage + 1); };

    document.addEventListener("DOMContentLoaded", initApp);
  </script>
</body>
</html>